version: "3.9"

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: onionrp/stream-overlay:latest
    env_file:
      - .env
    depends_on:
      - redis
    ports:
      - "13337:13337"
    volumes:
      - app-uploads:/app/uploads
      - app-data:/app/data
    restart: unless-stopped

  webrtc-node:
    image: node:20-alpine
    command: ["sh", "-c", "node -e 'console.log(\"webrtc-node placeholder\")' && tail -f /dev/null"]
    ports:
      - "13777:13777"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    restart: unless-stopped

  media-storage:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
    restart: unless-stopped

  coturn:
    image: coturn/coturn:4.6.3
    command:
      - -n
      - --fingerprint
      - --lt-cred-mech
      - --realm=onionrp.ru
      - --user=turnuser:turnpass
      - --listening-port=3478
      - --min-port=49160
      - --max-port=49200
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49160-49200:49160-49200/udp"
    restart: unless-stopped

volumes:
  app-uploads:
  app-data:
  redis-data:
  minio-data:
