services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: onionrp/stream-overlay:latest
    env_file:
      - .env
    depends_on:
      - redis
    ports:
      - "${APP_HTTP_BIND:-127.0.0.1}:${APP_HTTP_PORT:-13337}:13337"
    volumes:
      - app-uploads:/app/uploads
      - app-data:/app/data
    restart: unless-stopped

  webrtc-node:
    image: node:20-alpine
    command: ["sh", "-c", "node -e 'console.log(\"webrtc-node placeholder\")' && tail -f /dev/null"]
    ports:
      - "${WEBRTC_NODE_PORT:-13777}:13777"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    restart: unless-stopped

  media-storage:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    profiles: ["edge"]
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
    environment:
      NGINX_SERVER_NAME: ${NGINX_SERVER_NAME:-overlay.local}
      NGINX_UPSTREAM: ${NGINX_UPSTREAM:-http://web:13337}
    command:
      - /bin/sh
      - -c
      - |
        envsubst '$${NGINX_SERVER_NAME} $${NGINX_UPSTREAM}' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/nginx.conf
        exec nginx -g 'daemon off;'
    volumes:
      - ./infra/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    depends_on:
      - web
    restart: unless-stopped

  coturn:
    image: coturn/coturn:4.6.3
    command:
      - -n
      - --fingerprint
      - --lt-cred-mech
      - --realm=onionrp.ru
      - --user=turnuser:turnpass
      - --listening-port=3478
      - --min-port=49160
      - --max-port=49200
    ports:
      - "${TURN_PORT:-3478}:3478"
      - "${TURN_PORT:-3478}:3478/udp"
      - "${TURN_MIN_PORT:-49160}-${TURN_MAX_PORT:-49200}:${TURN_MIN_PORT:-49160}-${TURN_MAX_PORT:-49200}/udp"
    restart: unless-stopped

volumes:
  app-uploads:
  app-data:
  redis-data:
  minio-data:
